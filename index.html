<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Reflex Test ‚ö° Arcade Edition</title>

<!-- SOCIAL META -->
<meta property="og:title" content="Reflex Test ‚Äì Arcade Edition">
<meta property="og:description" content="Tap as fast as you can when the button turns green! Test your reflexes now.">
<meta property="og:image" content="https://reflex-s8dl.vercel.app/logo.png">

<!-- FARCASTER MINIAPP EMBED -->
<meta name="fc:miniapp" content='{
  "version": "1",
  "imageUrl": "https://reflex-s8dl.vercel.app/logo.png",
  "button": {
    "title": "‚ö° Play Reflex Test",
    "action": {
      "type": "launch_miniapp",
      "url": "https://reflex-s8dl.vercel.app/index.html",
      "name": "Cryptovorlaxis",
      "splashImageUrl": "https://reflex-s8dl.vercel.app/logo.png",
      "splashBackgroundColor": "#000000"
    }
  }
}' />

<style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');

    body {
        font-family: "Orbitron", sans-serif;
        background: radial-gradient(circle at center, #0a0f1e, #000);
        color: #0ff6d1;
        text-align: center;
        padding: 30px;
        overflow-x: hidden;
    }

    #leaderboard {
        margin-top: 40px;
        background: #001e1a;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 0 20px #00ffd522;
    }

    #leaderboard h2 {
        font-size: 24px;
        margin-bottom: 14px;
        color: #0ff6d1;
        text-shadow: 0 0 10px #00ffd5;
    }

    .lb-item {
        padding: 6px 0;
        font-size: 18px;
        border-bottom: 1px solid #0ff3;
    }

    .lb-item span {
        color: #aaffff;
    }
</style>

</head>
<body>

<img id="gameLogo" src="logo.png" alt="Reflex Test Logo">

<div id="status">Press START to begin.</div>

<button id="reactionButton">START</button>

<div id="score" class="hidden"></div>

<button id="againBtn" class="actionBtn hidden">Play Again</button>

<div id="leaderboard">
    <h2>üèÜ Leaderboard (Top 10)</h2>
    <div id="lb-list">Loading...</div>
</div>

<script type="module">
/* ------------------------------ */
/*         SUPABASE CLIENT        */
/* ------------------------------ */
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const SUPABASE_URL = "https://vxuxkirkpdgowhvqvsti.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dXhraXJrcGRnb3dodnF2c3RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDk3NzUsImV4cCI6MjA3OTg4NTc3NX0.rlHG7tnB2QMRFZGMW9o8DgCAHMEJzpS7FLvwbhywjZQ";

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

/* ------------------------------ */
/*     FARCASTER MINIAPP SDK     */
/* ------------------------------ */
import { sdk } from "https://esm.sh/@farcaster/miniapp-sdk";

let farcasterUser = null;

window.addEventListener("DOMContentLoaded", async () => {
    try {
        sdk.actions.ready();
        farcasterUser = await sdk.context.getUser();

        console.log("‚úì MiniApp Ready");
        console.log("User:", farcasterUser);

        loadLeaderboard();
    } catch (err) {
        console.error("MiniApp Init Error:", err);
    }
});

/* ------------------------------ */
/*           GAME LOGIC           */
/* ------------------------------ */

let gameState = "idle";
let startTime = 0;
let timeoutID;

const soundReady = new Audio("ready.mp3");
const soundFail = new Audio("fail.mp3");
const soundWin = new Audio("win.mp3");

const btn = document.getElementById("reactionButton");
const statusText = document.getElementById("status");
const scoreText = document.getElementById("score");
const againBtn = document.getElementById("againBtn");

btn.addEventListener("click", () => {
    if (gameState === "idle") startGame();
    else if (gameState === "ready") tooEarly();
    else if (gameState === "go") stopTimer();
});

againBtn.addEventListener("click", resetGame);

function startGame() {
    gameState = "ready";
    statusText.innerText = "Get ready...";
    btn.innerText = "WAIT";

    const waitTime = Math.floor(Math.random() * 3000) + 1500;

    timeoutID = setTimeout(() => {
        gameState = "go";
        btn.innerText = "TAP!";
        statusText.innerText = "NOW! üü¢";

        soundReady.play();
        startTime = Date.now();
    }, waitTime);
}

function tooEarly() {
    clearTimeout(timeoutID);
    gameState = "idle";
    statusText.innerText = "Too early! üòÖ";
    btn.innerText = "START";
    soundFail.play();
}

async function stopTimer() {
    const endTime = Date.now();
    const reactionTime = ((endTime - startTime) / 1000).toFixed(3);

    statusText.innerText = "Nice reflex! üéâ";
    scoreText.innerText = reactionTime + " s";
    scoreText.classList.remove("hidden");

    soundWin.play();
    gameState = "finished";

    // SAVE SCORE IN SUPABASE
    await saveScore(reactionTime);

    // LOAD NEW LEADERBOARD
    loadLeaderboard();
}

function resetGame() {
    gameState = "idle";
    statusText.innerText = "Press START to begin.";
    scoreText.classList.add("hidden");
    btn.innerText = "START";
}

/* ------------------------------ */
/*       SUPABASE FUNCTIONS      */
/* ------------------------------ */

async function saveScore(time) {
    if (!farcasterUser) return;

    const { fid, username } = farcasterUser;

    const { error } = await supabase.from("scores").insert({
        fid: fid,
        username: username,
        score: parseFloat(time)
    });

    if (error) console.error("Score save error:", error);
}

async function loadLeaderboard() {
    const lb = document.getElementById("lb-list");

    const { data, error } = await supabase
        .from("scores")
        .select("*")
        .order("score", { ascending: true })
        .limit(10);

    if (error) {
        lb.innerHTML = "Error loading leaderboard.";
        return;
    }

    lb.innerHTML = data
        .map(
            (row, i) =>
                `<div class="lb-item">#${i + 1} ‚Äî <b>${row.username}</b> <span>${row.score}s</span></div>`
        )
        .join("");
}
</script>

</body>
</html>
